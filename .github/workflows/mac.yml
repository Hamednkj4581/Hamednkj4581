name: 测试

on:
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# run-name: '${{ inputs.os }} ${{ inputs.port }}'

env:
  TZ: Asia/Shanghai

jobs:
  job:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: 测试
        run: |
          echo "## Ping 成功的 IP" >> $GITHUB_STEP_SUMMARY

          for i in {1..127}; do 
            (
              IP="70.36.96.$i"

              # 创建测量
              ID=$(curl -s -X POST "https://api.globalping.io/v1/measurements" \
                -H "Content-Type: application/json" \
                -d "{
                  \"target\": \"$IP\",
                  \"type\": \"ping\",
                  \"measurementOptions\": { \"packets\": 4 }
                }" | jq -r '.id')

              # 轮询直到测量完成
              while true; do
                RESPONSE=$(curl -s "https://api.globalping.io/v1/measurements/$ID")
                STATUS=$(echo "$RESPONSE" | jq -r '.status')
                echo $IP $STATUS
                if [[ "$STATUS" == "finished" ]]; then
                  LOSS=$(echo "$RESPONSE" | jq -r '.results[0].result.stats.loss')
                  if [[ "$LOSS" -lt 100 ]]; then
                    echo "- $IP (丢包率: ${LOSS}%)" >> $GITHUB_STEP_SUMMARY
                  fi
                  break
                fi
                sleep 1
              done
            ) &
          done

          # 等待所有后台任务完成
          wait

          # 统计成功 IP 数量
          SUCCESS_COUNT=$(grep -c '^-' $GITHUB_STEP_SUMMARY || true)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 总成功数: $SUCCESS_COUNT" >> $GITHUB_STEP_SUMMARY
